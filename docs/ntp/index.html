<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Network Time Protocol (NTP)</title>
<link href="../static/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="../static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../static/page.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<nav>
<a href="../">Home</a>
      ·
      <span class="dropdown">
<a href="#">Lessons</a>
<span class="dropdown-content" id="nav-lessons">
<a href="../intro/">Introduction</a>
<a href="../msgque/">A Message Queue</a>
<a href="../worksteal/">Work-Stealing Scheduler</a>
<a href="../tracing/">Distributed Tracing</a>
<a href="../crdt/">Conflict-Free Replicated Data Types</a>
<a href="../mapreduce/">MapReduce</a>
<a href="../oauth/">OAuth</a>
<a href="../distlock/">Distributed Locks</a>
<a href="../torrent/">BitTorrent</a>
<a href="../eventual/">Eventually Consistent Key-Value Store</a>
<a href="../saga/">The Saga Pattern</a>
<a href="../tcp/">TCP</a>
<a href="../dns/">DNS</a>
<a href="../ntp/">NTP</a>
<a href="../finale/">Conclusion</a>
</span>
</span>
      ·
      <span class="dropdown">
<a href="#">Appendices</a>
<span class="dropdown-content" id="nav-appendices">
<a href="../license/">License</a>
<a href="../conduct/">Code of Conduct</a>
<a href="../contributing/">Contributing</a>
<a href="../bibliography/">Bibliography</a>
<a href="../glossary/">Glossary</a>
</span>
</span>
</nav>
<main>
<h1>Network Time Protocol (NTP)</h1>
<p>Time synchronization is critical in distributed systems.
When multiple computers need to coordinate actions, order events, or maintain consistency, they must agree on what time it is.
Network Time Protocol (NTP) solves this by allowing computers to synchronize their clocks over a network with millisecond precision.</p>
<p>NTP powers everything from financial trading systems (where microseconds matter for transaction ordering) to distributed databases (which use timestamps for conflict resolution) to authentication systems (where time-based tokens expire).
Without NTP, a database might apply updates in the wrong order, a security token might be rejected as expired, or log files from different servers might be impossible to correlate.</p>
<h2>How NTP Works</h2>
<p>The challenge of clock synchronization is that network communication takes time.
If a server sends you "the current time is 12:00:00", by the time you receive that message, it's no longer 12:00:00—it's some amount later depending on network delay.</p>
<p>NTP solves this with a clever algorithm that measures both the clock offset (how far off your clock is) and the network delay.
It uses four timestamps:</p>
<ul>
<li><strong>t1</strong>: Client send time (when the client sends the request)</li>
<li><strong>t2</strong>: Server receive time (when the server receives the request)</li>
<li><strong>t3</strong>: Server transmit time (when the server sends the response)</li>
<li><strong>t4</strong>: Client receive time (when the client receives the response)</li>
</ul>
<p>From these four timestamps, NTP calculates:</p>
<div class="codehilite"><pre class=""><span></span><code>offset = ((t2 - t1) + (t3 - t4)) / 2
delay = (t4 - t1) - (t3 - t2)
</code></pre></div>
<p>The offset tells you how to adjust your clock. The delay tells you how reliable this measurement is (lower delay means more accurate).</p>
<h2>The Stratum Hierarchy</h2>
<p>NTP organizes time servers into levels called strata:</p>
<ul>
<li><strong>Stratum 0</strong>: Reference clocks (atomic clocks, GPS receivers)</li>
<li><strong>Stratum 1</strong>: Servers directly connected to stratum 0 (primary time servers)</li>
<li><strong>Stratum 2</strong>: Servers that sync with stratum 1</li>
<li><strong>Stratum 3</strong>: Servers that sync with stratum 2</li>
<li>And so on...</li>
</ul>
<p>This hierarchy prevents circular dependencies and allows the system to scale. End-user computers typically sync with stratum 2 or 3 servers.</p>
<h2>Implementation</h2>
<p>Let's build an NTP simulation using asimpy. We'll create servers, clients, and demonstrate clock synchronization.</p>
<p>First, the NTP message structure:</p>
<div data-filter="inc=ntpmessage" data-inc="ntp_message.py"><div class="codehilite"><pre class=""><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NTPMessage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A simplified NTP message packet."""</span>

    <span class="c1"># Client timestamps</span>
    <span class="n">t1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Client send time</span>
    <span class="n">t2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Server receive time</span>
    <span class="n">t3</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Server transmit time</span>
    <span class="n">t4</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Client receive time</span>

    <span class="c1"># Stratum level (distance from reference clock)</span>
    <span class="n">stratum</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate clock offset using NTP algorithm.</span>

<span class="sd">        offset = ((t2 - t1) + (t3 - t4)) / 2</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t4</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t4</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate round-trip delay.</span>

<span class="sd">        delay = (t4 - t1) - (t3 - t2)</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">t4</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t4</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.0</span>
</code></pre></div>
</div>
<p>The message holds the four timestamps and includes methods to calculate offset and delay using the NTP formulas.</p>
<p>Now the NTP server:</p>
<div data-filter="inc=ntpserver" data-inc="ntp_server.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NTPServer</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""An NTP time server that responds to client requests."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">stratum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">request_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
        <span class="n">network_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stratum</span> <span class="o">=</span> <span class="n">stratum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span> <span class="o">=</span> <span class="n">request_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span> <span class="o">=</span> <span class="n">network_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_served</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Process incoming NTP requests."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Wait for a request</span>
            <span class="n">client_queue</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># Record server receive time (t2)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>

            <span class="c1"># Simulate processing time</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

            <span class="c1"># Record server transmit time (t3)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span>
            <span class="n">message</span><span class="o">.</span><span class="n">stratum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratum</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (stratum </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stratum</span><span class="si">}</span><span class="s2">): "</span>
                <span class="sa">f</span><span class="s2">"Responding to request (t2=</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">t2</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, t3=</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">t3</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)"</span>
            <span class="p">)</span>

            <span class="c1"># Send response back to client with network delay</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">client_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">requests_served</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>
</div>
<p>The server receives requests, records timestamps t2 and t3, and sends responses back to clients.
In our simulation, the server's clock is accurate (it uses <code>self.now</code> which is the simulation's true time).
The <code>stratum</code> field indicates this server's level in the time hierarchy.</p>
<p>The NTP client is more complex because it must adjust its own clock:</p>
<div data-filter="inc=ntpclient" data-inc="ntp_client.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NTPClient</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""An NTP client that synchronizes its clock with a server."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">server_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
        <span class="n">sync_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">network_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">initial_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_queue</span> <span class="o">=</span> <span class="n">server_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_interval</span> <span class="o">=</span> <span class="n">sync_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span> <span class="o">=</span> <span class="n">network_delay</span>

        <span class="c1"># Client's local clock offset from true time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_offset</span> <span class="o">=</span> <span class="n">initial_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>

        <span class="c1"># Statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syncs_performed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_history</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_local_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get current time according to client's local clock."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock_offset</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Periodically sync with NTP server."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Wait for sync interval</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_interval</span><span class="p">)</span>

            <span class="c1"># Perform NTP sync</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sync_with_server</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_sync_with_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Execute one NTP synchronization cycle."""</span>
        <span class="c1"># Create request message with client send time (t1)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">NTPMessage</span><span class="p">(</span><span class="n">t1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_local_time</span><span class="p">())</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Sending sync request "</span>
            <span class="sa">f</span><span class="s2">"(local_time=</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">t1</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, offset=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clock_offset</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)"</span>
        <span class="p">)</span>

        <span class="c1"># Send request with network delay</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">response_queue</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>

        <span class="c1"># Wait for response</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Record client receive time (t4)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">t4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_time</span><span class="p">()</span>

        <span class="c1"># Calculate offset and delay</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">()</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">calculate_delay</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Received response "</span>
            <span class="sa">f</span><span class="s2">"(offset=</span><span class="si">{</span><span class="n">offset</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, delay=</span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)"</span>
        <span class="p">)</span>

        <span class="c1"># Adjust clock by the calculated offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_offset</span> <span class="o">-=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syncs_performed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Clock adjusted, "</span>
            <span class="sa">f</span><span class="s2">"new offset from true time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clock_offset</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
</code></pre></div>
</div>
<p>The client maintains a <code>clock_offset</code> representing how far its local clock differs from true time.
When it syncs, it calculates the offset using the NTP algorithm and adjusts its clock accordingly.</p>
<p>Notice <code>get_local_time()</code> returns the client's view of time, which may differ from simulation time until synchronization occurs.</p>
<h2>Running a Simulation</h2>
<p>Let's see clock synchronization in action:</p>
<div data-filter="inc=simulate" data-inc="simulate.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_ntp_simulation</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Simulate NTP clock synchronization."""</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>

    <span class="c1"># Create server queue</span>
    <span class="n">server_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="c1"># Create NTP server (stratum 1 - connected to reference clock)</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">NTPServer</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">"time.example.com"</span><span class="p">,</span> <span class="n">stratum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">request_queue</span><span class="o">=</span><span class="n">server_queue</span><span class="p">)</span>

    <span class="c1"># Create clients with different initial clock offsets</span>
    <span class="n">client1</span> <span class="o">=</span> <span class="n">NTPClient</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="s2">"client1.local"</span><span class="p">,</span>
        <span class="n">server_queue</span><span class="p">,</span>
        <span class="n">sync_interval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">initial_offset</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>  <span class="c1"># 2.5 seconds fast</span>
    <span class="p">)</span>

    <span class="n">client2</span> <span class="o">=</span> <span class="n">NTPClient</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="s2">"client2.local"</span><span class="p">,</span>
        <span class="n">server_queue</span><span class="p">,</span>
        <span class="n">sync_interval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">initial_offset</span><span class="o">=-</span><span class="mf">1.8</span><span class="p">,</span>  <span class="c1"># 1.8 seconds slow</span>
    <span class="p">)</span>

    <span class="n">client3</span> <span class="o">=</span> <span class="n">NTPClient</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span>
        <span class="s2">"client3.local"</span><span class="p">,</span>
        <span class="n">server_queue</span><span class="p">,</span>
        <span class="n">sync_interval</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
        <span class="n">initial_offset</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># 0.5 seconds fast</span>
    <span class="p">)</span>

    <span class="c1"># Run simulation</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

    <span class="c1"># Print statistics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== NTP Synchronization Statistics ==="</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Server requests served: </span><span class="si">{</span><span class="n">server</span><span class="o">.</span><span class="n">requests_served</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">client</span> <span class="ow">in</span> <span class="p">[</span><span class="n">client1</span><span class="p">,</span> <span class="n">client2</span><span class="p">,</span> <span class="n">client3</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Syncs performed: </span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">syncs_performed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  Final clock offset: </span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">clock_offset</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">client</span><span class="o">.</span><span class="n">offset_history</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"  Average correction: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">offset_history</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">offset_history</span><span class="p">)</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s"</span>
            <span class="p">)</span>
</code></pre></div>
</div>
<p>When you run this, you'll see clients starting with different clock offsets (some fast, some slow) and gradually converging toward the true time as they sync with the server.</p>
<p>Each client's clock offset decreases with each sync cycle. After a few iterations, all clients are within milliseconds of true time.</p>
<h2>Stratum Hierarchy</h2>
<p>In real NTP deployments, servers form a hierarchy. Let's simulate this:</p>
<div data-filter="inc=stratumserver" data-inc="stratum_hierarchy.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StratumServerProcess</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Server process for a stratum N+1 NTP server."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">local_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
        <span class="n">stratum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">clock_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">network_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_queue</span> <span class="o">=</span> <span class="n">local_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stratum</span> <span class="o">=</span> <span class="n">stratum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_state</span> <span class="o">=</span> <span class="n">clock_state</span>  <span class="c1"># Shared with client process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span> <span class="o">=</span> <span class="n">network_delay</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_local_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get current time according to local clock."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock_state</span><span class="p">[</span><span class="s2">"offset"</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Serve requests from downstream clients."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">client_queue</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># Record timestamps</span>
            <span class="n">message</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_time</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="n">message</span><span class="o">.</span><span class="n">t3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_time</span><span class="p">()</span>
            <span class="n">message</span><span class="o">.</span><span class="n">stratum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stratum</span>

            <span class="c1"># Send response</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">client_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div>
</div>
<div data-filter="inc=stratumclient" data-inc="stratum_hierarchy.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StratumClientProcess</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Client process for a stratum N+1 NTP server."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">upstream_queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
        <span class="n">stratum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">clock_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">sync_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">network_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upstream_queue</span> <span class="o">=</span> <span class="n">upstream_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stratum</span> <span class="o">=</span> <span class="n">stratum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_state</span> <span class="o">=</span> <span class="n">clock_state</span>  <span class="c1"># Shared with server process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_interval</span> <span class="o">=</span> <span class="n">sync_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span> <span class="o">=</span> <span class="n">network_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_local_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get current time according to local clock."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock_state</span><span class="p">[</span><span class="s2">"offset"</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Sync with upstream server."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_interval</span><span class="p">)</span>

            <span class="c1"># Send request to upstream</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">NTPMessage</span><span class="p">(</span><span class="n">t1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_local_time</span><span class="p">())</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_delay</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">upstream_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">response_queue</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>

            <span class="c1"># Wait for response</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">t4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_time</span><span class="p">()</span>

            <span class="c1"># Adjust clock (updates shared state)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clock_state</span><span class="p">[</span><span class="s2">"offset"</span><span class="p">]</span> <span class="o">-=</span> <span class="n">offset</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (stratum </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stratum</span><span class="si">}</span><span class="s2">): "</span>
                <span class="sa">f</span><span class="s2">"Synced with upstream, offset=</span><span class="si">{</span><span class="n">offset</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
</code></pre></div>
</div>
<p>A stratum N server needs to both sync with stratum N-1 (as a client) and serve stratum N+1 clients (as a server).
We implement this with two separate processes that share clock state via a dictionary.
The client process syncs with upstream and updates the shared clock offset.
The server process reads from the shared clock offset when responding to downstream requests.</p>
<p>This separation demonstrates an important pattern in asimpy: when you need concurrent behaviors, create separate Process classes that share state through Python objects (like our <code>clock_state</code> dictionary).</p>
<div data-filter="inc=hierarchy" data-inc="stratum_hierarchy.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_stratum_hierarchy</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Demonstrate NTP stratum hierarchy."""</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>

    <span class="c1"># Stratum 1: Primary time server</span>
    <span class="n">s1_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">stratum1</span> <span class="o">=</span> <span class="n">NTPServer</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s2">"stratum1.time.gov"</span><span class="p">,</span> <span class="n">stratum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">request_queue</span><span class="o">=</span><span class="n">s1_queue</span><span class="p">)</span>

    <span class="c1"># Stratum 2: Secondary servers syncing with stratum 1</span>
    <span class="c1"># Each stratum 2 server has both client and server processes</span>
    <span class="n">s2a_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">s2a_clock</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"offset"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>  <span class="c1"># Shared clock state</span>
    <span class="n">StratumClientProcess</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="s2">"stratum2a.org"</span><span class="p">,</span> <span class="n">s1_queue</span><span class="p">,</span> <span class="n">stratum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
        <span class="n">clock_state</span><span class="o">=</span><span class="n">s2a_clock</span><span class="p">,</span> <span class="n">sync_interval</span><span class="o">=</span><span class="mf">10.0</span>
    <span class="p">)</span>
    <span class="n">StratumServerProcess</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="s2">"stratum2a.org"</span><span class="p">,</span> <span class="n">s2a_queue</span><span class="p">,</span> <span class="n">stratum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">clock_state</span><span class="o">=</span><span class="n">s2a_clock</span>
    <span class="p">)</span>

    <span class="n">s2b_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">s2b_clock</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"offset"</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>  <span class="c1"># Shared clock state</span>
    <span class="n">StratumClientProcess</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="s2">"stratum2b.org"</span><span class="p">,</span> <span class="n">s1_queue</span><span class="p">,</span> <span class="n">stratum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">clock_state</span><span class="o">=</span><span class="n">s2b_clock</span><span class="p">,</span> <span class="n">sync_interval</span><span class="o">=</span><span class="mf">10.0</span>
    <span class="p">)</span>
    <span class="n">StratumServerProcess</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="s2">"stratum2b.org"</span><span class="p">,</span> <span class="n">s2b_queue</span><span class="p">,</span> <span class="n">stratum</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">clock_state</span><span class="o">=</span><span class="n">s2b_clock</span>
    <span class="p">)</span>

    <span class="c1"># Stratum 3: End clients</span>
    <span class="n">client_a</span> <span class="o">=</span> <span class="n">NTPClient</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="s2">"client_a"</span><span class="p">,</span> <span class="n">s2a_queue</span><span class="p">,</span> <span class="n">sync_interval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">initial_offset</span><span class="o">=</span><span class="mf">3.0</span>
    <span class="p">)</span>

    <span class="n">client_b</span> <span class="o">=</span> <span class="n">NTPClient</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="s2">"client_b"</span><span class="p">,</span> <span class="n">s2b_queue</span><span class="p">,</span> <span class="n">sync_interval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">initial_offset</span><span class="o">=-</span><span class="mf">2.0</span>
    <span class="p">)</span>

    <span class="c1"># Run simulation</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">=== Stratum Hierarchy Results ==="</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Stratum 1 server requests: </span><span class="si">{</span><span class="n">stratum1</span><span class="o">.</span><span class="n">requests_served</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Stratum 2a clock offset: </span><span class="si">{</span><span class="n">s2a_clock</span><span class="p">[</span><span class="s1">'offset'</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Stratum 2b clock offset: </span><span class="si">{</span><span class="n">s2b_clock</span><span class="p">[</span><span class="s1">'offset'</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Client A final offset: </span><span class="si">{</span><span class="n">client_a</span><span class="o">.</span><span class="n">clock_offset</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Client B final offset: </span><span class="si">{</span><span class="n">client_b</span><span class="o">.</span><span class="n">clock_offset</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">s"</span><span class="p">)</span>
</code></pre></div>
</div>
<p>In this simulation, stratum 1 servers sync with reference clocks (simulated as perfect time), stratum 2 servers sync with stratum 1, and end clients sync with stratum 2.</p>
<p>The key insight is that synchronization error accumulates as you go down the hierarchy, but it's still accurate enough for most purposes. A stratum 3 client might be accurate to within a few milliseconds, which is perfectly adequate for log timestamps or cache expiration.</p>
<h2>Real-World Considerations</h2>
<p>Our simulation simplifies several aspects of real NTP:</p>
<ol>
<li>
<p><strong>Network jitter</strong>: Real networks have variable delay. NTP uses statistical filtering to handle this.</p>
</li>
<li>
<p><strong>Clock drift</strong>: Computer clocks drift over time due to temperature and crystal imperfections. NTP compensates by adjusting the clock frequency, not just the offset.</p>
</li>
<li>
<p><strong>Multiple servers</strong>: Clients typically query multiple servers and use the median to filter out bad sources.</p>
</li>
<li>
<p><strong>Security</strong>: NTP can be spoofed. Modern deployments use NTS (Network Time Security) for authentication.</p>
</li>
<li>
<p><strong>Precision</strong>: Real NTP achieves millisecond accuracy over the internet and microsecond accuracy on LANs.</p>
</li>
</ol>
<h2>Why This Matters</h2>
<p>Clock synchronization is often invisible until it breaks. Consider these scenarios:</p>
<ul>
<li>
<p><strong>Distributed databases</strong>: Cassandra uses timestamps to resolve conflicting writes. If clocks are skewed, the wrong value might win.</p>
</li>
<li>
<p><strong>Security</strong>: Kerberos tickets are time-limited. If a client's clock is wrong by more than 5 minutes, authentication fails.</p>
</li>
<li>
<p><strong>Compliance</strong>: Financial regulations require accurate timestamps on all trades. Being off by even seconds can violate regulations.</p>
</li>
<li>
<p><strong>Debugging</strong>: When troubleshooting a distributed system failure, accurate timestamps in logs are essential for understanding the sequence of events.</p>
</li>
</ul>
<p>NTP is one of the oldest internet protocols (dating from 1985) but remains fundamental to modern systems. Understanding how it works helps you reason about time in distributed systems and appreciate the complexity of seemingly simple operations like "what time is it?"</p>
<h2>Conclusion</h2>
<p>NTP demonstrates how to solve a fundamental distributed systems problem: establishing a shared view of time despite network delays and imperfect clocks.</p>
<p>The four-timestamp algorithm elegantly separates network delay from clock offset, allowing precise synchronization over unreliable networks.
The stratum hierarchy provides scalability without sacrificing accuracy.</p>
<p>Our asimpy implementation captures the essence of NTP: clients sync periodically with servers, calculate offset and delay, and adjust their clocks.
Real implementations add sophistication (filtering, drift compensation, security), but the core algorithm remains the same.</p>
<p>Time synchronization is a prerequisite for many distributed system techniques—from distributed transactions to event ordering to cache consistency.
NTP makes it practical.</p>
</main>
<footer>
<div class="row">
<div class="col-3 left">
	  ⇐ <a href="../dns/">DNS</a>
</div>
<div class="col-6 center">
<a href="../"></a>
	  © 2025
	  <a href="../#acknowledgments">the authors</a>
</div>
<div class="col-3 right">
<a href="../finale/">Conclusion</a> ⇒
	</div>
</div>
</footer>
</body>
</html>