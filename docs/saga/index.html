<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>The Saga Pattern</title>
<link href="../static/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="../static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../static/page.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<nav>
<a href="../">Home</a>
      ·
      <span class="dropdown">
<a href="#">Lessons</a>
<span class="dropdown-content" id="nav-lessons">
<a href="../intro/">Introduction</a>
<a href="../oauth/">OAuth</a>
<a href="../msgque/">A Message Queue</a>
<a href="../distlock/">Distributed Locks</a>
<a href="../tracing/">Distributed Tracing</a>
<a href="../eventual/">Eventually Consistent Key-Value Store</a>
<a href="../saga/">The Saga Pattern</a>
<a href="../mapreduce/">MapReduce</a>
<a href="../worksteal/">Work-Stealing Scheduler</a>
<a href="../crdt/">Conflict-Free Replicated Data Types</a>
<a href="../torrent/">BitTorrent</a>
<a href="../tcp/">TCP</a>
<a href="../finale/">Conclusion</a>
</span>
</span>
      ·
      <span class="dropdown">
<a href="#">Appendices</a>
<span class="dropdown-content" id="nav-appendices">
<a href="../license/">License</a>
<a href="../conduct/">Code of Conduct</a>
<a href="../contributing/">Contributing</a>
<a href="../bibliography/">Bibliography</a>
<a href="../glossary/">Glossary</a>
</span>
</span>
</nav>
<main>
<h1>The Saga Pattern</h1>
<p>When you book a flight, reserve a hotel, and rent a car in a single transaction, what happens if the car rental fails but the flight and hotel are already reserved? In a monolithic database, you'd roll back the entire transaction.
But in a microservices architecture with separate databases for flights, hotels, and cars, traditional ACID transactions don't work.
The Saga pattern solves this by breaking long-running transactions into a sequence of local transactions, each with a compensating action to undo its effects if the overall transaction fails.</p>
<p>Netflix uses Sagas to coordinate video encoding pipelines across multiple services.
E-commerce platforms use them for order processing—reserving inventory, charging payment, arranging shipping.
Travel booking systems use them to coordinate flights, hotels, and rental cars.
The Saga pattern enables distributed transactions without distributed locks, maintaining eventual consistency while handling failures gracefully.</p>
<p>This pattern emerged from a fundamental limitation: distributed transactions using two-phase commit (2PC) don't scale.
They require holding locks across services, creating bottlenecks and failure points.
Sagas trade immediate consistency for availability and fault tolerance—a deliberate choice that fits modern distributed systems.</p>
<h2>The Saga Pattern</h2>
<p>A Saga is a sequence of local transactions where each transaction updates a single service and publishes an event or message to trigger the next transaction.
If a transaction fails, the Saga executes compensating transactions to undo the changes made by preceding transactions.</p>
<p>The pattern has two main approaches:</p>
<p><strong>Orchestration</strong>: A central coordinator tells each service what to do.
Easier to understand and monitor, but the coordinator is a coordination point.</p>
<p><strong>Choreography</strong>: Each service listens for events and decides what to do next.
Decentralized, no single point of coordination, but harder to understand and monitor.</p>
<p>The key components are:</p>
<ol>
<li><strong>Local transactions</strong>: Each service performs its own transaction</li>
<li><strong>Compensating transactions</strong>: Reverse the effects of local transactions  </li>
<li><strong>Saga coordinator</strong> (orchestration): Manages the sequence</li>
<li><strong>Events</strong> (choreography): Trigger next steps in the sequence</li>
</ol>
<p>Unlike 2PC which uses prepare/commit phases and locks, Sagas commit each step immediately and use compensation to handle failures.</p>
<h2>Core Data Structures</h2>
<p>Let's build a travel booking Saga with flights, hotels, and car rentals:</p>
<div class="codehilite"><pre class=""><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">asimpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SagaStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Status of a saga execution."""</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">"pending"</span>
    <span class="n">IN_PROGRESS</span> <span class="o">=</span> <span class="s2">"in_progress"</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">"completed"</span>
    <span class="n">COMPENSATING</span> <span class="o">=</span> <span class="s2">"compensating"</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">"failed"</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TransactionStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Status of individual transaction."""</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">"pending"</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">"completed"</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">"failed"</span>
    <span class="n">COMPENSATED</span> <span class="o">=</span> <span class="s2">"compensated"</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SagaStep</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""A step in the saga with transaction and compensation."""</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>  <span class="c1"># Returns True if successful</span>
    <span class="n">compensation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>  <span class="c1"># Returns True if successful</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Step(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)"</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SagaExecution</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Tracks execution of a saga instance."""</span>
    <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SagaStep</span><span class="p">]</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">SagaStatus</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">PENDING</span>
    <span class="n">current_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">completed_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">failed_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Saga(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">saga_id</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BookingRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Travel booking request."""</span>
    <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">flight_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">hotel_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">car_id</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Booking(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">booking_id</span><span class="si">}</span><span class="s2">)"</span>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SagaEvent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Event in choreographed saga."""</span>
    <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># "flight_booked", "flight_failed", etc.</span>
    <span class="n">saga_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"Event(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">event_type</span><span class="si">}</span><span class="s2">)"</span>
</code></pre></div>
<p>These structures represent the Saga's state machine.
Each step has a forward transaction and a backward compensation.</p>
<h2>Service Implementations</h2>
<p>Let's implement the microservices that participate in the Saga.
Each service manages its own local state and provides both forward (book) and backward (cancel) operations:</p>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FlightService</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Microservice for booking flights."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService started (seats: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Handle flight booking requests."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">book_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flight_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Book a flight (forward transaction)."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: Booking flight </span><span class="si">{</span><span class="n">flight_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Simulate occasional failures</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: Booking FAILED - system error"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: Booking FAILED - no seats"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"flight_id"</span><span class="p">:</span> <span class="n">flight_id</span><span class="p">,</span>
            <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"booked"</span><span class="p">,</span>
            <span class="s2">"seats"</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: ✓ Flight booked "</span>
              <span class="sa">f</span><span class="s2">"(remaining: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Cancel flight booking (compensation)."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: COMPENSATING - "</span>
              <span class="sa">f</span><span class="s2">"canceling </span><span class="si">{</span><span class="n">booking_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">booking_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: No booking to cancel"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">seats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"seats"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span> <span class="o">+=</span> <span class="n">seats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">][</span><span class="s2">"status"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"canceled"</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] FlightService: ✓ Flight canceled "</span>
              <span class="sa">f</span><span class="s2">"(available: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_seats</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HotelService</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Microservice for booking hotels."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService started (rooms: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Handle hotel booking requests."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">book_hotel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hotel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Book a hotel (forward transaction)."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: Booking hotel </span><span class="si">{</span><span class="n">hotel_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Simulate occasional failures  </span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: Booking FAILED - no rooms"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: Booking FAILED - no rooms"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"hotel_id"</span><span class="p">:</span> <span class="n">hotel_id</span><span class="p">,</span>
            <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"booked"</span><span class="p">,</span>
            <span class="s2">"rooms"</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: ✓ Hotel booked "</span>
              <span class="sa">f</span><span class="s2">"(remaining: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_hotel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Cancel hotel booking (compensation)."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: COMPENSATING - "</span>
              <span class="sa">f</span><span class="s2">"canceling </span><span class="si">{</span><span class="n">booking_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">booking_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: No booking to cancel"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">rooms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"rooms"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span> <span class="o">+=</span> <span class="n">rooms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">][</span><span class="s2">"status"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"canceled"</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] HotelService: ✓ Hotel canceled "</span>
              <span class="sa">f</span><span class="s2">"(available: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_rooms</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CarRentalService</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Microservice for renting cars."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService started (cars: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Handle car rental requests."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">book_car</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">car_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Book a car (forward transaction)."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: Booking car </span><span class="si">{</span><span class="n">car_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Simulate higher failure rate for demonstration</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: Booking FAILED - no cars"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: Booking FAILED - no cars"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"car_id"</span><span class="p">:</span> <span class="n">car_id</span><span class="p">,</span>
            <span class="s2">"status"</span><span class="p">:</span> <span class="s2">"booked"</span><span class="p">,</span>
            <span class="s2">"cars"</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: ✓ Car booked "</span>
              <span class="sa">f</span><span class="s2">"(remaining: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_car</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Cancel car rental (compensation)."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: COMPENSATING - "</span>
              <span class="sa">f</span><span class="s2">"canceling </span><span class="si">{</span><span class="n">booking_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">booking_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: No booking to cancel"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">cars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"cars"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span> <span class="o">+=</span> <span class="n">cars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookings</span><span class="p">[</span><span class="n">booking_id</span><span class="p">][</span><span class="s2">"status"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"canceled"</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] CarRentalService: ✓ Car canceled "</span>
              <span class="sa">f</span><span class="s2">"(available: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_cars</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>Each service is autonomous—it manages its own database and can succeed or fail independently.</p>
<h2>Orchestration-Based Saga</h2>
<p>The orchestrator coordinates the sequence of transactions.
It executes steps sequentially and handles compensation if any step fails:</p>
<div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SagaOrchestrator</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Centralized saga coordinator (orchestration pattern)."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_service</span><span class="p">:</span> <span class="n">FlightService</span><span class="p">,</span>
             <span class="n">hotel_service</span><span class="p">:</span> <span class="n">HotelService</span><span class="p">,</span>
             <span class="n">car_service</span><span class="p">:</span> <span class="n">CarRentalService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flight_service</span> <span class="o">=</span> <span class="n">flight_service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hotel_service</span> <span class="o">=</span> <span class="n">hotel_service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car_service</span> <span class="o">=</span> <span class="n">car_service</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_sagas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SagaExecution</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sagas_completed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sagas_failed</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] SagaOrchestrator started</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Process booking requests."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_saga</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_saga</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booking</span><span class="p">:</span> <span class="n">BookingRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Execute travel booking saga."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="s1">'='</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] Starting saga for </span><span class="si">{</span><span class="n">booking</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="s1">'='</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Define saga steps</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SagaStep</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"book_flight"</span><span class="p">,</span>
                <span class="n">service_name</span><span class="o">=</span><span class="s2">"FlightService"</span><span class="p">,</span>
                <span class="n">transaction</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flight_service</span><span class="o">.</span><span class="n">book_flight</span><span class="p">(</span>
                    <span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span><span class="p">,</span> <span class="n">booking</span><span class="o">.</span><span class="n">flight_id</span>
                <span class="p">),</span>
                <span class="n">compensation</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flight_service</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span>
                    <span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">SagaStep</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"book_hotel"</span><span class="p">,</span>
                <span class="n">service_name</span><span class="o">=</span><span class="s2">"HotelService"</span><span class="p">,</span>
                <span class="n">transaction</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hotel_service</span><span class="o">.</span><span class="n">book_hotel</span><span class="p">(</span>
                    <span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span><span class="p">,</span> <span class="n">booking</span><span class="o">.</span><span class="n">hotel_id</span>
                <span class="p">),</span>
                <span class="n">compensation</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hotel_service</span><span class="o">.</span><span class="n">cancel_hotel</span><span class="p">(</span>
                    <span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">SagaStep</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">"book_car"</span><span class="p">,</span>
                <span class="n">service_name</span><span class="o">=</span><span class="s2">"CarRentalService"</span><span class="p">,</span>
                <span class="n">transaction</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">car_service</span><span class="o">.</span><span class="n">book_car</span><span class="p">(</span>
                    <span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span><span class="p">,</span> <span class="n">booking</span><span class="o">.</span><span class="n">car_id</span>
                <span class="p">),</span>
                <span class="n">compensation</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># Last step doesn't need compensation</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="n">saga</span> <span class="o">=</span> <span class="n">SagaExecution</span><span class="p">(</span>
            <span class="n">saga_id</span><span class="o">=</span><span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span><span class="p">,</span>
            <span class="n">steps</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">SagaStatus</span><span class="o">.</span><span class="n">IN_PROGRESS</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">active_sagas</span><span class="p">[</span><span class="n">booking</span><span class="o">.</span><span class="n">booking_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">saga</span>

        <span class="c1"># Execute forward transactions</span>
        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_forward</span><span class="p">(</span><span class="n">saga</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">saga</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">COMPLETED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sagas_completed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] ✓✓✓ Saga </span><span class="si">{</span><span class="n">saga</span><span class="o">.</span><span class="n">saga_id</span><span class="si">}</span><span class="s2"> COMPLETED ✓✓✓</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Execute compensations</span>
            <span class="n">saga</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">COMPENSATING</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_compensation</span><span class="p">(</span><span class="n">saga</span><span class="p">)</span>
            <span class="n">saga</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SagaStatus</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sagas_failed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] ✗✗✗ Saga </span><span class="si">{</span><span class="n">saga</span><span class="o">.</span><span class="n">saga_id</span><span class="si">}</span><span class="s2"> FAILED - "</span>
                  <span class="sa">f</span><span class="s2">"compensated ✗✗✗</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga</span><span class="p">:</span> <span class="n">SagaExecution</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Execute forward transactions in sequence."""</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">steps</span><span class="p">):</span>
            <span class="n">saga</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">i</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] Orchestrator: Executing step </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/"</span>
                  <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Simulate network delay</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

            <span class="c1"># Execute transaction</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">transaction</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">saga</span><span class="o">.</span><span class="n">completed_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">saga</span><span class="o">.</span><span class="n">failed_step</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">name</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] Orchestrator: Step </span><span class="si">{</span><span class="n">step</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> FAILED"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_compensation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saga</span><span class="p">:</span> <span class="n">SagaExecution</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Execute compensating transactions in reverse order."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] Orchestrator: Starting compensation..."</span><span class="p">)</span>

        <span class="c1"># Compensate in reverse order</span>
        <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">saga</span><span class="o">.</span><span class="n">completed_steps</span><span class="p">):</span>
            <span class="c1"># Find the step</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">saga</span><span class="o">.</span><span class="n">steps</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">step_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">compensation</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] Orchestrator: Compensating </span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

                <span class="c1"># Simulate network delay</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

                <span class="n">success</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">compensation</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] Orchestrator: WARNING - "</span>
                          <span class="sa">f</span><span class="s2">"Compensation </span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2"> failed! Manual intervention needed."</span><span class="p">)</span>
</code></pre></div>
<p>The orchestrator provides a clear, centralized view of the workflow.
It's easy to monitor and debug.</p>
<h2>Basic Orchestration Example</h2>
<p>Let's see orchestration in action:</p>
<div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_orchestrated_saga</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Demonstrate orchestration-based saga."""</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">()</span>

    <span class="c1"># Create services</span>
    <span class="n">flight_service</span> <span class="o">=</span> <span class="n">FlightService</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">hotel_service</span> <span class="o">=</span> <span class="n">HotelService</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">car_service</span> <span class="o">=</span> <span class="n">CarRentalService</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="c1"># Create orchestrator</span>
    <span class="n">orchestrator</span> <span class="o">=</span> <span class="n">SagaOrchestrator</span><span class="p">(</span>
        <span class="n">env</span><span class="p">,</span> <span class="n">flight_service</span><span class="p">,</span> <span class="n">hotel_service</span><span class="p">,</span> <span class="n">car_service</span>
    <span class="p">)</span>

    <span class="c1"># Submit booking requests</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">BookingGenerator</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orch</span><span class="p">:</span> <span class="n">SagaOrchestrator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orch</span> <span class="o">=</span> <span class="n">orch</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">booking</span> <span class="o">=</span> <span class="n">BookingRequest</span><span class="p">(</span>
                    <span class="n">booking_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">"BOOK</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                    <span class="n">customer_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">"CUST</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                    <span class="n">flight_id</span><span class="o">=</span><span class="s2">"FL123"</span><span class="p">,</span>
                    <span class="n">hotel_id</span><span class="o">=</span><span class="s2">"HTL456"</span><span class="p">,</span>
                    <span class="n">car_id</span><span class="o">=</span><span class="s2">"CAR789"</span>
                <span class="p">)</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">orch</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">booking</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="n">BookingGenerator</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">orchestrator</span><span class="p">)</span>

    <span class="c1"># Run simulation</span>
    <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

    <span class="c1"># Print summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Final State:"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Flight seats available: </span><span class="si">{</span><span class="n">flight_service</span><span class="o">.</span><span class="n">available_seats</span><span class="si">}</span><span class="s2">/10"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Hotel rooms available: </span><span class="si">{</span><span class="n">hotel_service</span><span class="o">.</span><span class="n">available_rooms</span><span class="si">}</span><span class="s2">/5"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cars available: </span><span class="si">{</span><span class="n">car_service</span><span class="o">.</span><span class="n">available_cars</span><span class="si">}</span><span class="s2">/3"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Completed sagas: </span><span class="si">{</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">sagas_completed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed sagas: </span><span class="si">{</span><span class="n">orchestrator</span><span class="o">.</span><span class="n">sagas_failed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">run_orchestrated_saga</span><span class="p">()</span>
</code></pre></div>
<p>This demonstrates how compensation restores system state when bookings fail partway through.</p>
<h2>Key Saga Concepts</h2>
<h3>Compensating Transactions</h3>
<p>Compensations are NOT rollbacks—they're forward operations that semantically undo effects:</p>
<ul>
<li><strong>Cancel reservation</strong> (not "delete booking record")</li>
<li><strong>Refund payment</strong> (not "undo charge")</li>
<li><strong>Return inventory</strong> (not "remove allocation")</li>
</ul>
<p>Compensations must be:
- <strong>Idempotent</strong>: Can be retried safely
- <strong>Retryable</strong>: Will eventually succeed<br/>
- <strong>Commutative</strong>: Order doesn't matter (where possible)</p>
<h3>Semantic Locking</h3>
<p>Prevent dirty reads during saga execution:</p>
<ul>
<li>Mark records as "pending"</li>
<li>Users see "Processing..." status</li>
<li>Don't show incomplete state</li>
<li>Use optimistic locking for conflicts</li>
</ul>
<h3>Pivot Transaction</h3>
<p>The last transaction in a Saga that can't be compensated.
For example:
- Sending email notification
- Shipping physical goods
- Executing wire transfer</p>
<p>Design Sagas so risky operations happen early (compensatable) and irreversible operations happen last.</p>
<h2>Trade-offs: Orchestration vs Choreography</h2>
<p><strong>Orchestration Advantages</strong>:
- Easy to understand and debug
- Centralized monitoring
- Clear workflow visualization
- Simpler testing
- Easy to add/modify steps</p>
<p><strong>Orchestration Disadvantages</strong>:
- Coordinator is coordination point
- Coordinator becomes complex for large sagas
- Services coupled to orchestrator</p>
<p><strong>Choreography Advantages</strong>:
- No central coordinator
- Services more loosely coupled
- Better for event-driven architectures
- Scales better
- Natural for domain events</p>
<p><strong>Choreography Disadvantages</strong>:
- Hard to understand overall flow
- Difficult to monitor
- Debugging is challenging
- Circular dependencies possible
- No single source of truth for saga state</p>
<h2>Saga vs Two-Phase Commit</h2>
<table>
<thead>
<tr>
<th></th>
<th>Saga</th>
<th>2PC</th>
</tr>
</thead>
<tbody>
<tr>
<td>Locks</td>
<td>No locks</td>
<td>Locks resources</td>
</tr>
<tr>
<td>Isolation</td>
<td>Not isolated</td>
<td>Full isolation</td>
</tr>
<tr>
<td>Consistency</td>
<td>Eventual</td>
<td>Immediate</td>
</tr>
<tr>
<td>Availability</td>
<td>High</td>
<td>Lower</td>
</tr>
<tr>
<td>Coordinator failure</td>
<td>Can recover</td>
<td>Blocks system</td>
</tr>
<tr>
<td>Cross-org</td>
<td>Works</td>
<td>Impractical</td>
</tr>
<tr>
<td>Complexity</td>
<td>Compensations</td>
<td>Prepare/commit</td>
</tr>
</tbody>
</table>
<p>Sagas are preferred for microservices because they don't require locks and work across organizational boundaries.</p>
<h2>Conclusion</h2>
<p>The Saga pattern enables distributed transactions through eventual consistency.
The key principles are:</p>
<ol>
<li><strong>Local transactions</strong>: Each service commits independently</li>
<li><strong>Compensations</strong>: Semantic undo operations</li>
<li><strong>No distributed locks</strong>: Services don't block each other</li>
<li><strong>Eventual consistency</strong>: State converges over time</li>
<li><strong>Graceful degradation</strong>: Failures trigger compensations</li>
</ol>
<p>Sagas trade immediate consistency for availability and scalability.
They work best when:</p>
<ul>
<li>Traditional 2PC is impractical</li>
<li>Services have separate databases</li>
<li>Long-running transactions span services</li>
<li>Eventual consistency is acceptable</li>
<li>Operations are compensatable</li>
</ul>
</main>
<footer>
<div class="row">
<div class="col-3 left">
	  ⇐ <a href="../eventual/">Eventually Consistent Key-Value Store</a>
</div>
<div class="col-6 center">
<a href="../"></a>
	  © 2025
	  <a href="../#acknowledgments">the authors</a>
</div>
<div class="col-3 right">
<a href="../mapreduce/">MapReduce</a> ⇒
	</div>
</div>
</footer>
</body>
</html>